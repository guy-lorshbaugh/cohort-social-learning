<!-- Renders form fields and displays errors -->
{% macro render_field(field) %}
    <div class="field">
        {% if field.errors %}
            {% for error in field.errors %}
                <div class="notification error">{{ error }}</div>
            {% endfor %}
        {% endif %}
        {{ field(placeholder=field.label.text) }}
    </div>
{% endmacro %}

<!-- Renders HTML for emoji menu. -->
{% macro emoji_menu(emoji) %}
    <div id="emoji-menu-prototype">
        <div class="emoji-category-nav">
            <ul>
            </ul>
        </div>
        <div class="emoji-search-dummy">
            <input type="text" id="emoji-search-opener" disabled placeholder="Search Emoji">
            <span class="material-icons emoji-search-icon">search</span>
        </div>
        <!-- <div class="emoji-search-container" style="display: none;">
            <div class="emoji-search-results emoji-container">
            </div>
        </div> -->
        <!-- <div class ="tone-picker">
            <div class="tone-choice default" tone="default"> </div>
            <div class="tone-choice light" tone="skin-tone-1"> </div>
            <div class="tone-choice mediumlight" tone="skin-tone-2"> </div>
            <div class="tone-choice medium" tone="skin-tone-3"> </div>
            <div class="tone-choice mediumdark" tone="skin-tone-4"> </div>
            <div class="tone-choice dark" tone="skin-tone-5"> </div>
        </div> -->
        <div class="kiss-selector shadow-box" style="display: none;">
            {% for entry in emoji 
               if "People & Body" in entry["category"]
               and "kiss" in entry["name"]
               and "skin-tone-" not in entry["name"] %}
               <span class="emoji" tone="none" title="{{ entry['name'] }}">{{ entry['char'] }}</span>
            {% endfor %}
        </div>
        <div class="hands-selector shadow-box" style="display: none;">
            {% for entry in emoji 
               if "People & Body" in entry["category"]
               and "holding hands" in entry["name"]
               and "skin-tone-" not in entry["name"] %}
               <span class="emoji" tone="none" title="{{ entry['name'] }}">{{ entry['char'] }}</span>
            {% endfor %}
        </div>
        <div class="family-selector shadow-box" style="display: none;">
            {% for entry in emoji 
               if "People & Body" in entry["category"]
               and "family" in entry["name"]
               and "skin-tone-" not in entry["name"] %}
               <span class="emoji" tone="none" title="{{ entry['name'] }}">{{ entry['char'] }}</span>
            {% endfor %}
        </div>
        <div class="couple-selector shadow-box" style="display: none;">
            {% for entry in emoji 
               if "People & Body" in entry["category"]
               and "couple" in entry["name"]
               and "skin-tone-" not in entry["name"] %}
               <span class="emoji" tone="none" title="{{ entry['name'] }}">{{ entry['char'] }}</span>
            {% endfor %}
        </div>
        <div class="emoji-list-container" id="emoji-list-container">
            <span class="emoji-anchor" name="recent-emoji"></span>
        {% set categories = [] %}
        {% set exclude = [ 'face in clouds', 'face with spiral eyes',
            'face exhaling', 'heart on fire', 'mending heart',
            'eye in speech bubble', 'man: beard', 'woman: beard', 'man in tuxedo',
            'woman in tuxedo', 'man with veil', 'woman with veil',
            'woman feeding baby', 'man feeding baby', 'person feeding baby',
            'man golfing', 'woman golfing', 'woman bouncing ball',
            'man bouncing ball', 'man lifting weights', 'mx claus',
            'woman lifting weights', 'kiss: woman, man',
            'kiss: man, man', 'kiss: woman, woman',
            'couple with heart: man, woman', 'couple with heart: woman, woman',
            'couple with heart: man, man', 'couple with heart: woman, man', 
            'transgender flag', 'smiling face with tear', 'disguised face',
            'pinched fingers', 'anatomical heart', 'lungs', 'ninja',
            'people hugging', 'black cat', 'bison', 'mammoth', 'beaver',
            'dodo', 'feather', 'seal, beetle', 'cockroach', 'fly', 
            'worm', 'potted plant', 'blueberries', 'olive', 'bell pepper',
            'flatbread', 'tamale', 'fondue', 'teapot', 'pinched fingers',
            'anatomical heart no_tone', 'lungs no_tone', 'people hugging',
            'seal', 'beetle', 'rock', 'wood', 'hut', 'roller skate',
            'bubble tea', 'polar bear', 'pickup truck', 'magic wand',
            'pinata', 'nesting dolls', 'sewing needle', 'knot',
            'thong sandal', 'military helmet', 'accordion', 'long drum',
            'coin', 'boomerang', 'carpentry saw', 'screwdriver', 'hook',
            'ladder', 'elevator', 'mirror', 'window', 'plunger',
            'mouse trap', 'bucket', 'toothbrush', 'placard', 'headstone'
             ] %}
        {% for item in emoji %}
            {% if item['group'] not in categories: %}
                <!-- {{ categories.append(item['group']) }} -->
            {% endif %}
        {% endfor %}
        {% for item in categories %}
            {% if item == "Component" %}
                {{ pass }}
            {% elif item == "People & Body" %}
                <span class="emoji-anchor" name="{{ item.replace(' ', '').replace('&', '-').lower() }}"></span>
                <h6 >{{ item }}</h6>
                <div class="emoji-container people-body">
                    {% for entry in emoji if "People & Body" in entry["category"] %}
                        {% set name = entry["name"] %}
                        {% if "holding hands" in name %}
                            {{ pass }}
                        {% elif name in exclude %}
                            {{ pass }}
                        {% elif "kiss" in name %}
                            {{ pass }}
                        {% elif "couple with heart" in name %}
                            {{ pass }}
                        {% elif "family" in name %}
                            {{ pass }}
                        {% elif "no_tone" in name %}
                            <span class="emoji" tone="none" title="{{ entry['name'] }}">{{ entry['char'] }}</span>
                        {% elif "skin-tone" not in name %}
                            <span class="emoji" tone="default" title="{{ entry['name'] }}">{{ entry['char'] }}</span>
                        {% elif "skin-tone-1" in name %}
                            {{ pass }}
                            <!-- <span class="emoji" tone="skin-tone-1" title="{{ entry['name'] }}">{{ entry['char'] }}</span> -->
                        {% elif "skin-tone-2" in name %}
                            {{ pass }}
                            <!-- <span class="emoji" tone="skin-tone-2" title="{{ entry['name'] }}">{{ entry['char'] }}</span> -->
                        {% elif "skin-tone-3" in name %}
                            {{ pass }}
                            <!-- <span class="emoji" tone="skin-tone-3" title="{{ entry['name'] }}">{{ entry['char'] }}</span> -->
                        {% elif "skin-tone-4" in name %}
                            {{ pass }}
                            <!-- <span class="emoji" tone="skin-tone-4" title="{{ entry['name'] }}">{{ entry['char'] }}</span> -->
                        {% elif "skin-tone-5" in name %}
                            {{ pass }}
                            <!-- <span class="emoji" tone="skin-tone-5" title="{{ entry['name'] }}">{{ entry['char'] }}</span> -->
                        {% endif %}
                    {% endfor %}
                    <span class="emoji kiss-opener" id="kiss" tone="none" title="kiss-default">üíè</span>
                    <span class="emoji hands-opener" id="hands" tone="none" title="hands-default">üßë‚Äçü§ù‚Äçüßë</span>
                    <span class="emoji family-opener" id="family" tone="none" title="family-default">üë™</span>
                    <span class="emoji couple-opener" id="couple" tone="none" title="couple-default">üíë</span>
                </div>
            {% else %}
                <span class="emoji-anchor" name="{{ item.replace(' ', '').replace('&', '-').lower() }}"></span>
                <h6 >{{ item }}</h6>
                <div class="emoji-container {{ item.lower().replace(' ', '-').replace('&', '').replace('--','-') }}">
                    {% for entry in emoji %}
                        {% if entry['group'] == item %}
                            {% if entry['name'] in exclude %}
                                {{ pass }}
                            {% else %}
                                <span class="emoji" title="{{ entry['name'] }}">{{ entry['char'] }}</span>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}
        </div>
    </div>
{% endmacro %}


<!-- 
    Macro write_comments takes in database and user data to render 
    comments for a single entry.
-->
{% macro write_comments(comments, models, current_user) %}
    {% for comment in comments %}
        {% set comment_user = (models.User
            .get(models.User.id == comment.user_id)
        ) %}
        <div class="single-comment emoji-span" id="comment-{{ comment.id }}">
            <div class="comment-avatar">
                <img class="avatar-25" src="{{ comment_user.avatar }}">
            </div>
            <div class="comment-username">
                {{ comment_user.username }}, <span class="comment-date">{{ relative_time(comment) }}</span>
            </div>
            <div class="comment-contents" id="comment-contents-{{ comment.id }}">
                {{ comment.contents|safe }}
            </div>
            {% if comment.user_id == current_user.id %}
                <div class="option-button comment-options" role="button" id="comment-options-{{ comment.id }}">
                    more_vert
                </div>
                <div class="option-menu comment-menu" id="comment-menu-{{comment.id}}" style="visibility: hidden;">
                    <ul>
                        {% set comment_delete_url = url_for('delete_comment', comment = comment.id) %}
                        <li id="edit-comment-{{ comment.id }}" class="edit-comment">Edit Comment</li>
                        <li id="delete-comment-{{ comment.id }}" class="delete-comment delete-option">Delete Comment</li>
                    </ul>
                </div>
                <div class="confirm-comment-delete" id="confirm-dialog-{{ comment.id }}" style="visibility: hidden;">
                    <div style="padding-bottom: 5px;">Are you sure?</div>
                    <button name="yes" class="button button-secondary" type="button">Yes</button>
                    <button name ="no" class="button button-secondary" type="button">No</button>
                </div>
            {% endif %}
            <div class="comment-like-reply">
                <ul>
                    <li class="comment-like">thumb_up</li>
                    <li class="comment-reply">comment</li>
                    <!-- <li class="comment-date small">{ { relative_time(comment) } }</li>
                    <li>file_upload</li>
                    <li>share</li> -->
                </ul>
            </div>
            <div class="comment-edit-dialog shadow-box" 
                 id="comment-edit-dialog-{{comment.id}}"
                 style="visibility: hidden;">
                <form>
                    <textarea class="comment-field comment-edit" 
                              id="comment-edit-{{comment.id}}" 
                              style="overflow-wrap: break-word; 
                                    height: 50px;"></textarea>
                    <input type="button" 
                           value="Save" 
                           class="button button-secondary comment-edit-post-button">
                        <div class="shadow-box comment-edit-cancel-button material-icons"
                             id="cancel-button-{{comment.id}}">cancel</div>
                </form>
                <!-- Below will be filled by Javascript to show either ‚åò or Ctrl -->
                <div class="cmd-enter small"></div>
                <div id="comment-edit-error-{{comment.id}}" 
                     class="error-bubble" 
                     style="visibility: hidden"></div>
                <script type="text/javascript">autosize(document.getElementById("comment-edit-{{comment.id}}"))</script>
            </div>
        </div>
    {% endfor %}
{% endmacro %}

{% macro relative_time(entry) %}
    {% set now = insert_now %}
    {% set rel_time = now - entry.date %}
    {% if rel_time.seconds < 60 %}
        A moment ago
    {% elif entry.date.day == now.day and rel_time.seconds < 3600 %}
        {{ (rel_time.seconds/60)|round|int }} minutes ago
    {% elif entry.date == now.date and rel_time.seconds > 3600 %}
        1 hour ago
    {% elif entry.date.day == now.day 
            and rel_time.seconds > 5400
            and rel_time.seconds < 21600 %}
        {{ (rel_time.seconds/3600)|round|int }} hours ago
    {% elif entry.date.day == now.day 
            and rel_time.seconds > 21600
            and rel_time.days == 0 %}
        today, {{ entry.date.strftime('%I:%M %p') }}
    {% elif now.year == entry.date.year 
            and entry.date.day == now.day - 1 %}
        yesterday, {{ entry.date.strftime('%I:%M %p') }}
    {% elif now.year == entry.date.year %}
        {{ entry.date.strftime('%B %d') }}
    {% elif now.year > entry.date.year %}
        {{ entry.date.strftime('%B %d %Y') }}
    {% endif %}
{% endmacro %}

{% macro process_tags(tags) %}
    {% set tags_list = [] %}
    {% for tag in tags %}
        {% if tag.tag == '' %}
            {{ pass }}
        {% else %}
            {{ tags_list.append(tag) or "" }}
        {% endif %}
    {% endfor %}
    {% if tags_list|length == 0 %}
        {{ pass }}
    {% else %}
        <div class="tags small">
            {% for tag in tags: %}
                <a class="tag-bubble" style="text-decoration:none;" href="{{ url_for('tag', tag=tag.tag) }}">{{ tag.tag }}</a>
            {% endfor %}
        </div>
    {% endif %}
{% endmacro %}

<!-- Renders HTML from entry data -->
{% macro write_entry(entry) %}
    {% if not entry.private %}
        {% set user = models.User.get(models.User.id==entry.user_id) %}
        <!-- <article class="entry-edit-container" class="visibility: hidden;">
            { { edit_entry(entry, form = edit_form) } }
        </article> -->
        <article class="entry-preview-container" id="entry-{{ entry.id }}">
            <div class="entry-title-bar">
                <div class="entry-title-avatar">
                    <img class="avatar-25" src="{{ user.avatar }}">
                </div>
                <div class="user-date small">
                    By <a style="text-decoration:none; color:black;" 
                        href="{{ url_for('user', id=entry.user_id) }}">
                    {{ user.username }}</a>,
                    <time>
                        {{ relative_time(entry) }}
                    </time>
                </div>
                <div class="entry-title"><a class="entry-title-anchor" href="{{ url_for('detail', id=entry.id) }}">{{ entry.title }}</a></div>
            </div>
            
            {% if entry.user_id == current_user.id %}
                <div class="option-button entry-options" 
                        role="button" 
                        id="entry-options-{{ entry.id }}">
                    more_vert
                </div>
                <div class="option-menu entry-menu" 
                        id="entry-menu-{{entry.id}}" 
                        style="visibility: hidden;">
                    <ul>
                        <!-- { % set entry_delete_url = url_for('delete_entry', entry = entry.id) % } -->
                        <li id="edit-entry-{{ entry.id }}"
                            class="entry-edit-option">Edit Entry</li>
                        <li id="delete-entry-{{ entry.id }}" 
                            class="entry-delete-option">Delete Entry</li>
                    </ul>
                </div>
                <div class="entry-confirm-dialog" id="entry-confirm-dialog-{{ entry.id }}" style="visibility: hidden;">
                    <div style="padding-bottom: 5px;">Are you sure?</div>
                    <button name="yes" class="button button-secondary yes" type="button">Yes</button>
                    <button name ="no" class="button button-secondary" type="button">No</button>
                </div>
            {% endif %}
            <div id="entry-preview-{{ entry.id }}" class="entry-preview">
                <!-- { { entry.learned|truncate(length=140, killwords=True, end='...') } } -->
                <div class="entry-preview-content">
                    {% for item in entry.learned.split("\n") %}
                        <div class="entry-preview-line">{{ item|safe }}</div>
                    {% endfor %}
                </div>
            </div>
            <!-- <div class="like-comment-display"> -->
                {% set likes = (
                    models.Entry
                    .select()
                    .join(models.EntryLikes)
                    .join(models.User)
                    .where(models.Entry.id == entry.id)
                    .order_by(models.User.username)
                ) %}
                {% set comments = (models.Comment
                    .select()
                    .where(models.Comment.entry_id == entry.id)
                    .order_by(models.Comment.id)
                ) %}

                <!-- LIKE & COMMENT COUNT DISPLAY -->
                    
                    <!-- LIKERS HOVER DISPLAY -->
                    <div class="likers likers-{{ entry.id }} shadow-box">
                        <dl>
                            {% set likers = (
                                models.User
                                .select()
                                .join(models.EntryLikes)
                                .join(models.Entry)
                                .where(models.Entry.id == entry.id)
                                .order_by(models.User.username)
                            ) %}
                        {% for liker in likers %}
                            {% if liker.username == current_user.username %}
                                <dt><img class="avatar-15" 
                                        src="{{ liker.avatar }}">&nbsp;You!</dt>
                            {% else %}
                                <dt><img 
                                    class="avatar-15" 
                                    src="{{ liker.avatar }}">&nbsp;{{ liker.username }}</dt>
                            {% endif %}
                        {% endfor %}
                        </dl>
                    </div>
            <!-- </div> -->
            
            <!-- TAGS -->
            
            {% set tags = (models.Tags
                .select()
                .join(models.EntryTags)
                .join(models.Entry)
                .where(models.Entry.id == entry.id)
                .order_by(models.Tags.id)
                ) %}
                {{ process_tags(tags) }}

            <!-- LIKE & COMMENT BUTTONS -->

            <div class="like-button-container">
                {% if likes.count() > 0 %}
                    <div class="like-count" onmouseover="likerDisplay('likers likers-{{ entry.id }}')">
                        <div class="like-number">
                            {{ likes.count() }}
                        </div>
                    </div>
                {% endif %}
                {% if comments.count() > 0 %}
                    <div class="comment-count">
                        {{ comments.count() }}
                    </div>
                {% endif %}    
                {% if current_user.is_authenticated %}
                    <span class="like" 
                            role="button"
                            onclick="likeRequest('{{ url_for("like", entry=entry.id) }}', '{{ entry.id }}')">
                        {% if (
                            models.EntryLikes
                            .select()
                            .join(models.Entry)
                            .where(models.EntryLikes.user_id == current_user.id,
                                models.EntryLikes.entry_id == entry.id)
                            .exists()
                        ) %}
                            Unlike
                        {% else %}
                            Like
                        {% endif %}
                    </span>
                    <label class="comment-button" role="button" for="comment-{{ entry.id }}">Comment</label>
                {% endif %}
            </div>

            <!--  COMMENTS -->

            <div class="comments-container  {{ entry.id }}">
                {{ write_comments(comments, models, current_user) }}
            </div>

            <!-- COMMENT FORM -->

            <!-- <div id="comment-form-error-{{ entry.id }}" class="comment-form-error"></div> -->
            <div class="comment-field-container">
                <form method="POST" action="#">
                    <div id="emoji-search-{{ entry }}" 
                        class="emoji-search-container"
                        style="visibility: hidden">
                        <div class="emoji-search">
                            <input type="text" id="emoji-search-input" placeholder="Search Emoji">
                            <span class="material-icons emoji-search-icon">search</span>
                        </div>
                        <div class="emoji-search-results emoji-container"></div>
                    </div>
                    <div id="emoji-menu-{{ entry }}" 
                        class="emoji-menu-container"
                        style="visibility: hidden"></div>
                    <input id="token-{{ entry.id }}" 
                        type="hidden" value="{{ csrf_token() }}">
                    <textarea placeholder="Comment" 
                                id="comment-{{ entry.id }}"
                                class="comment-field"
                                type="text"
                                required="required"
                                aria-required="true"></textarea>
                    <div id="comment-error-{{entry.id}}" 
                            class="error-bubble" 
                            style="visibility: hidden"></div>
                    <div id="emoji-open-{{ entry.id }}" 
                            class="emoji-open" style="visibility: visible">sentiment_satisfied_alt</div>
                    <div id="emoji-search-open-{{ entry.id }}" 
                            class="emoji-search-open" style="visibility: hidden">search</div>
                    <input type="button"
                            onclick="commentRequest('create', '/entries/{{ entry.id }}/comment/', {{ entry.id }})" 
                            value="Post" class="button button-secondary comment-post-button invalid"
                    >
                    <script type="text/javascript">
                        autosize(document.getElementById("comment-{{ entry.id }}"))
                    </script>
                </form>
            </div>
        </article>
    {% endif %}
{% endmacro %}